#
# Macros
#
<Macro Common $subdomain>
    ErrorLog logs/$subdomain_error.log
    CustomLog logs/access.log netdata
    CustomLog logs/$subdomain_access.log netdata
</Macro>

<Macro HTTPCommon $subdomain>
    Use Common $subdomain
</Macro>

<Macro HTTPSCommon $domain $subdomain>
    Use Common $subdomain

    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

    SSLEngine on
    SSLCertificateFile /usr/local/apache2/conf/letsencrypt/live/$domain/fullchain.pem
    SSLCertificateKeyFile /usr/local/apache2/conf/letsencrypt/live/$domain/privkey.pem
</Macro>

<Macro Redirect $domain $subdomain>
    Redirect permanent / https://$subdomain.$domain/
</Macro>

<Macro HTTPRoot $domain $subdomain>
    ServerName $domain
    Use Redirect $domain $subdomain

    Use HTTPCommon $subdomain
</Macro>

<Macro HTTPSRoot $domain $subdomain>
    ServerName $domain
    Use Redirect $domain $subdomain

    Use HTTPSCommon $domain $subdomain
</Macro>

<Macro HTTP $domain $subdomain>
    ServerName $subdomain.$domain
    Use Redirect $domain $subdomain

    Use HTTPCommon $subdomain
</Macro>

<Macro HTTPS $domain $subdomain $host $port>
    ServerName $subdomain.$domain

    ProxyPass / http://$host:$port/ retry=0
    ProxyPassReverse / http://$host:$port/

    Use HTTPSCommon $domain $subdomain
</Macro>

<Macro Auth $domain $subdomain $passphrase $clientid $clientsecret $users>
    Redirect /redirect /

    OIDCRedirectURI https://$subdomain.$domain/redirect
    OIDCCryptoPassphrase $passphrase
    OIDCProviderMetadataURL https://accounts.google.com/.well-known/openid-configuration
    OIDCScope "openid email"
    OIDCClientID $clientid
    OIDCClientSecret $clientsecret

    <Proxy>
      AuthType openid-connect
      AuthName $subdomain
      Require claim "email~($users)@gmail\.com"
    </Proxy>
</Macro>

#
# HTTP and HTTPS virtual host macros
#
<Macro HTTPVirtualHost $domain $subdomain>
    <VirtualHost *:80>
        Use HTTP $domain $subdomain
    </VirtualHost>
</Macro>

<Macro HTTPVirtualHostRoot $domain $subdomain>
    <VirtualHost *:80>
        Use HTTPRoot $domain $subdomain
    </VirtualHost>
</Macro>

<Macro HTTPSVirtualHost $domain $subdomain $host $port>
    <VirtualHost *:443>
        Use HTTPS $domain $subdomain $host $port
    </VirtualHost>
</Macro>

<Macro HTTPSVirtualHostAuth $domain $subdomain $host $port $passphrase $clientid $clientsecret $users>
    <VirtualHost *:443>
        Use HTTPS $domain $subdomain $host $port
        Use Auth $domain $subdomain $passphrase $clientid $clientsecret $users
    </VirtualHost>
</Macro>

<Macro HTTPSVirtualHostRoot $domain $subdomain>
    <VirtualHost *:443>
        Use HTTPSRoot $domain $subdomain
    </VirtualHost>
</Macro>

#
# Virtual host macros
#
<Macro VirtualHost $domain $subdomain $host $port>
    Use HTTPVirtualHost $domain $subdomain
    Use HTTPSVirtualHost $domain $subdomain $host $port
</Macro>

<Macro VirtualHostRoot $domain $subdomain $host $port>
    Use HTTPVirtualHostRoot $domain $subdomain
    Use HTTPVirtualHost $domain $subdomain
    Use HTTPSVirtualHostRoot $domain $subdomain
    Use HTTPSVirtualHost $domain $subdomain $host $port
</Macro>

<Macro VirtualHostAuth $domain $subdomain $host $port $passphrase $clientid $clientsecret $users>
    Use HTTPVirtualHost $domain $subdomain
    Use HTTPSVirtualHostAuth $domain $subdomain $host $port $passphrase $clientid $clientsecret $users
</Macro>

<Macro VirtualHostAuthRoot $domain $subdomain $host $port $passphrase $clientid $clientsecret $users>
    Use HTTPVirtualHostRoot $domain $subdomain
    Use HTTPVirtualHost $domain $subdomain
    Use HTTPSVirtualHostRoot $domain $subdomain
    Use HTTPSVirtualHostAuth $domain $subdomain $host $port $passphrase $clientid $clientsecret $users
</Macro>

#
# Virtual hosts
#
Use VirtualHostAuthRoot ${DOMAIN} netdata netdata 19999 ${PASSPHRASE} ${CLIENT_ID} ${CLIENT_SECRET} ${USERS}
Use VirtualHostAuth ${DOMAIN} grafana grafana 3000 ${PASSPHRASE} ${CLIENT_ID} ${CLIENT_SECRET} ${USERS}
Use VirtualHost ${DOMAIN} plex plex 32400
Use VirtualHostAuth ${DOMAIN} plexpy plexpy 8181 ${PASSPHRASE} ${CLIENT_ID} ${CLIENT_SECRET} ${USERS}
Use VirtualHostAuth ${DOMAIN} movies radarr 7878 ${PASSPHRASE} ${CLIENT_ID} ${CLIENT_SECRET} ${USERS}
Use VirtualHostAuth ${DOMAIN} tv sonarr 8989 ${PASSPHRASE} ${CLIENT_ID} ${CLIENT_SECRET} ${USERS}
Use VirtualHostAuth ${DOMAIN} transmission transmission 9091 ${PASSPHRASE} ${CLIENT_ID} ${CLIENT_SECRET} ${USERS}

#
# Sever status virtual host
#
<VirtualHost *:80>
    ServerName apache

    <Location /server-status>
        SetHandler server-status
        Require all granted
    </Location>
</VirtualHost>
