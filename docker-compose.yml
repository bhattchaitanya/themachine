version: '3'

services:
  nginx:
    container_name: nginx
    image: nginx
    command: >
      /bin/bash -c
      "BASIC_AUTH=$$(echo -n $USERNAME:$PASSWORD | base64) \
       envsubst '$$BASIC_AUTH' < etc/nginx/proxy-auth-header.conf.template > /etc/nginx/proxy-auth-header.conf &&
       envsubst '$$DOMAIN' < etc/nginx/nginx.conf.template > /etc/nginx/nginx.conf &&
       nginx -g 'daemon off;'"
    hostname: &hostname $HOSTNAME
    environment:
      DOMAIN: $DOMAIN
    restart: unless-stopped
    ports:
      - 80:80
      - 443:443
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - $SERVER_DIR/nginx/logs:/var/log/nginx/logs
      - $SERVER_DIR/letsencrypt:/etc/letsencrypt:ro
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf.template:ro
      - ./nginx/auth-location.conf:/etc/nginx/auth-location.conf:ro
      - ./nginx/auth-request.conf:/etc/nginx/auth-request.conf:ro
      - ./nginx/proxy-auth-header.conf:/etc/nginx/proxy-auth-header.conf.template:ro
      - ./nginx/proxy-header.conf:/etc/nginx/proxy-header.conf:ro
      - ./nginx/proxy-pass.conf:/etc/nginx/proxy-pass.conf:ro

  oauth2_proxy:
    container_name: oauth2_proxy
    image: a5huynh/oauth2_proxy
    command: >
      -config=/etc/oauth2_proxy/oauth2_proxy.cfg
      -client-id=$CLIENT_ID
      -client-secret=$CLIENT_SECRET
      -cookie-secret=$COOKIE_SECRET
    hostname: *hostname
    environment:
      CLIENT_ID: $CLIENT_ID
      CLIENT_SECRET: $CLIENT_SECRET
      COOKIE_SECRET: $COOKIE_SECRET
    restart: unless-stopped
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./oauth2_proxy:/etc/oauth2_proxy:ro

  netdata:
    container_name: netdata
    image: netdata/netdata
    hostname: *hostname
    environment:
      PGID: $DOCKER_GID
    cap_add:
      - SYS_PTRACE
    security_opt:
      - apparmor:unconfined
    restart: unless-stopped
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - $SERVER_DIR/nginx/logs:/var/log/nginx:ro
      - $DATA_DIR:/data
      - ./netdata/netdata.conf:/etc/netdata/netdata.conf:ro
      - ./netdata/apps_groups.conf:/etc/netdata/apps_groups.conf:ro
      - ./netdata/fping.conf:/etc/netdata/fping.conf:ro
      - ./netdata/nginx.conf:/etc/netdata/python.d/nginx.conf:ro
      - ./netdata/web_log.conf:/etc/netdata/python.d/web_log.conf:ro

  influxdb:
    container_name: influxdb
    image: influxdb
    hostname: *hostname
    restart: unless-stopped
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - $SERVER_DIR/influxdb:/var/lib/influxdb
      - ./influxdb/influxdb.conf:/etc/influxdb/influxdb.conf:ro

  grafana:
    container_name: grafana
    image: grafana/grafana
    hostname: *hostname
    restart: unless-stopped
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - $SERVER_DIR/grafana:/var/lib/grafana
      - ./grafana/grafana.ini:/etc/grafana/grafana.ini:ro
      - ./grafana/datasource.yaml:/etc/grafana/provisioning/datasources/datasource.yaml:ro

  pihole:
    container_name: pihole
    image: pihole/pihole
    hostname: *hostname
    environment:
      ServerIP: 0.0.0.0
      WEBPASSWORD: $PASSWORD
    cap_add:
      - NET_ADMIN
    dns:
      - 127.0.0.1
      - 1.1.1.1
    restart: unless-stopped
    ports:
      - 53:53/tcp
      - 53:53/udp
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - $SERVER_DIR/pihole/pihole:/etc/pihole
      - $SERVER_DIR/pihole/dnsmasq:/etc/dnsmasq.d

  iperf:
    container_name: iperf
    image: networkstatic/iperf3
    command: >
      -s
    hostname: *hostname
    restart: unless-stopped
    ports:
      - 5201:5201
    volumes:
      - /etc/localtime:/etc/localtime:ro

  plex:
    container_name: plex
    image: plexinc/pms-docker:plexpass
    hostname: *hostname
    environment:
      PLEX_UID: $UID
      PLEX_GID: $GID
      ADVERTISE_IP: http://$PLEX_IP:32400
      ALLOWED_NETWORKS: 10.0.0.0/8,172.16.0.0/12,192.168.0.0/16
    devices:
      - /dev/dri
    restart: unless-stopped
    ports:
      - 32400:32400
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - $SERVER_DIR/plex/config:/config
      - $DATA_DIR/tv:/tv
      - $DATA_DIR/movies:/movies

  tautulli:
    container_name: tautulli
    image: tautulli/tautulli
    hostname: *hostname
    environment:
      PUID: $UID
      PGID: $GID
    restart: unless-stopped
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - $SERVER_DIR/tautulli/config:/config

  radarr:
    container_name: radarr
    image: linuxserver/radarr
    hostname: *hostname
    environment: &environment-linuxserver
      PUID: $UID
      PGID: $GID
    restart: unless-stopped
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - $SERVER_DIR/radarr/config:/config
      - $DATA_DIR/downloads:/downloads
      - $DATA_DIR/movies:/movies

  sonarr:
    container_name: sonarr
    image: linuxserver/sonarr
    hostname: *hostname
    environment: *environment-linuxserver
    restart: unless-stopped
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - $SERVER_DIR/sonarr/config:/config
      - $DATA_DIR/downloads:/downloads
      - $DATA_DIR/tv:/tv

  jackett:
    container_name: jackett
    image: linuxserver/jackett
    hostname: *hostname
    environment: *environment-linuxserver
    restart: unless-stopped
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - $SERVER_DIR/jackett/config:/config

  transmission:
    container_name: transmission
    image: haugene/transmission-openvpn
    hostname: *hostname
    environment:
      OPENVPN_PROVIDER: $OPENVPN_PROVIDER
      OPENVPN_CONFIG: $OPENVPN_CONFIG
      OPENVPN_USERNAME: $OPENVPN_USERNAME
      OPENVPN_PASSWORD: $OPENVPN_PASSWORD
      TRANSMISSION_DOWNLOAD_DIR: /downloads/complete
      TRANSMISSION_INCOMPLETE_DIR: /downloads/incomplete
      TRANSMISSION_RATIO_LIMIT: 0
      TRANSMISSION_RATIO_LIMIT_ENABLED: "true"
      TRANSMISSION_RPC_AUTHENTICATION_REQUIRED: "true"
      TRANSMISSION_RPC_USERNAME: $USERNAME
      TRANSMISSION_RPC_PASSWORD: $PASSWORD
      TRANSMISSION_HOME: /transmission
      TRANSMISSION_WEB_HOME: /web
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun
    dns:
      - 1.1.1.1
      - 1.0.0.1
    restart: unless-stopped
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - $SERVER_DIR/transmission:/transmission
      - $DATA_DIR/downloads:/downloads
      - $TRANSMISSION_WEB_DIR:/web:ro

  spyfall:
    container_name: spyfall
    image: pkoenig10/spyfall
    hostname: *hostname
    restart: unless-stopped
    volumes:
      - /etc/localtime:/etc/localtime:ro

  watchtower:
    container_name: watchtower
    image: v2tec/watchtower
    command: >
      --schedule "0 0 4 * * *"
      --cleanup
    restart: unless-stopped
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock
